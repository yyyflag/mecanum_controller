<?xml version="1.0"?>
<robot name="mecanum_yahboomcar"
       xmlns:xacro="http://www.ros.org/wiki/xacro">

    <!-- 数学常数定义 -->
    <xacro:property name="M_PI" value="3.1415926535897931" />
    
    <!-- Base footprint (地面投影点) -->
    <link name="base_footprint"/>

    <!-- Main body -->
    <link name="base_link">
        <inertial>
            <origin xyz="0 0 0.04" rpy="0 0 0"/>
            <mass value="1.0"/>
            <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="0.16 0.17 0.08"/>
            </geometry>
            <material name="green">
                <color rgba="0 0.7 0 1"/>
            </material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="0.16 0.17 0.08"/>
            </geometry>
        </collision>
    </link>

    <!-- base_footprint to base_link -->
    <joint name="base_joint" type="fixed">
        <parent link="base_footprint"/>
        <child link="base_link"/>
        <origin xyz="0 0 0.0815" rpy="0 0 0"/>
    </joint>

    <!-- IMU -->
    <link name="imu_link">
        <inertial>
            <mass value="0.01"/>
            <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
        </inertial>
    </link>
    <joint name="base_imu" type="fixed">
        <parent link="base_link"/>
        <child link="imu_link"/>
        <origin xyz="-0.06 0.01 0.01" rpy="0 3.1415 1.5707"/>
    </joint>

    <!-- Laser Mount (支撑柱) -->
    <link name="laser_mount">
        <inertial>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <mass value="0.05"/>
            <inertia ixx="5e-5" ixy="0" ixz="0" iyy="5e-5" iyz="0" izz="1e-6"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="0.005" length="0.1"/>
            </geometry>
            <material name="darkgray"><color rgba="0.3 0.3 0.3 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="0.005" length="0.1"/>
            </geometry>
        </collision>
    </link>

    <!-- 激光支架连接到小车主体 -->
    <joint name="laser_mount_joint" type="fixed">
        <parent link="base_link"/>
        <child link="laser_mount"/>
        <origin xyz="0.0435 0 0.04" rpy="0 0 0"/>
    </joint>

    <!-- Laser Scanner -->
    <link name="laser_link">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="0.1"/>
            <inertia ixx="2e-5" ixy="0" ixz="0" iyy="8e-5" iyz="0" izz="1e-4"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="0.025" length="0.04"/>
            </geometry>
            <material name="gray"><color rgba="0.7 0.7 0.7 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="0.025" length="0.04"/>
            </geometry>
        </collision>
    </link>

    <!-- 激光雷达连接到支架顶部 -->
    <joint name="laser_joint" type="fixed">
        <parent link="laser_mount"/>
        <child link="laser_link"/>
        <origin xyz="0 0 0.12" rpy="0 0 0"/>
    </joint>

    <!-- Camera -->
    <link name="camera_link">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="0.02"/>
            <inertia ixx="1e-6" ixy="0.0" ixz="0.0" iyy="1e-6" iyz="0.0" izz="1e-6"/>
        </inertial>
        <visual>
            <geometry>
                <box size="0.03 0.04 0.03"/>
            </geometry>
            <material name="red"><color rgba="1 0 0 1"/></material>
        </visual>
        <collision>
            <geometry>
                <box size="0.03 0.04 0.03"/>
            </geometry>
        </collision>
    </link>
    
    <!-- Camera Joint -->
    <joint name="camera_joint" type="fixed">
        <parent link="base_link"/>
        <child link="camera_link"/>
        <origin xyz="0.08 0 0.04" rpy="0 0 0"/>
    </joint>

    <!-- ==================== MECANUM WHEELS ==================== -->

    <!-- Wheel parameters -->
    <xacro:property name="wheel_radius" value="0.0325"/>
    <xacro:property name="wheel_width" value="0.02"/>
    <xacro:property name="wheel_mass" value="0.1"/>
    
    <!-- 轮子惯性矩阵计算 -->
    <xacro:property name="wheel_ixx" value="${0.5 * wheel_mass * wheel_radius * wheel_radius}"/>
    <xacro:property name="wheel_iyy" value="${(1/12) * wheel_mass * (3 * wheel_radius * wheel_radius + wheel_width * wheel_width)}"/>
    <xacro:property name="wheel_izz" value="${wheel_iyy}"/>

    <!-- 四个轮子的定义（保持不变） -->
    <!-- Front Right Wheel -->
    <link name="front_right_wheel">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${wheel_mass}"/>
            <inertia ixx="${wheel_ixx}" ixy="0.0" ixz="0.0" iyy="${wheel_iyy}" iyz="0.0" izz="${wheel_izz}"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
            <material name="gray"><color rgba="0.7 0.7 0.7 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
        </collision>
    </link>
    
    <joint name="front_right_joint" type="continuous">
        <parent link="base_link"/>
        <child link="front_right_wheel"/>
        <origin xyz="0.08 -0.0845 -0.0075" rpy="0 0 -0.7854"/>
        <axis xyz="0 1 0"/>
        <limit effort="100" velocity="10"/>
    </joint>

    <!-- Front Left Wheel -->
    <link name="front_left_wheel">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${wheel_mass}"/>
            <inertia ixx="${wheel_ixx}" ixy="0.0" ixz="0.0" iyy="${wheel_iyy}" iyz="0.0" izz="${wheel_izz}"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
            <material name="gray"><color rgba="0.7 0.7 0.7 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
        </collision>
    </link>
    
    <joint name="front_left_joint" type="continuous">
        <parent link="base_link"/>
        <child link="front_left_wheel"/>
        <origin xyz="0.08 0.0845 -0.0075" rpy="0 0 0.7854"/>
        <axis xyz="0 1 0"/>
        <limit effort="100" velocity="10"/>
    </joint>

    <!-- Back Right Wheel -->
    <link name="back_right_wheel">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${wheel_mass}"/>
            <inertia ixx="${wheel_ixx}" ixy="0.0" ixz="0.0" iyy="${wheel_iyy}" iyz="0.0" izz="${wheel_izz}"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
            <material name="gray"><color rgba="0.7 0.7 0.7 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
        </collision>
    </link>
    
    <joint name="back_right_joint" type="continuous">
        <parent link="base_link"/>
        <child link="back_right_wheel"/>
        <origin xyz="-0.08 -0.0845 -0.0075" rpy="0 0 0.7854"/>
        <axis xyz="0 1 0"/>
        <limit effort="100" velocity="10"/>
    </joint>

    <!-- Back Left Wheel -->
    <link name="back_left_wheel">
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${wheel_mass}"/>
            <inertia ixx="${wheel_ixx}" ixy="0.0" ixz="0.0" iyy="${wheel_iyy}" iyz="0.0" izz="${wheel_izz}"/>
        </inertial>
        <visual>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
            <material name="gray"><color rgba="0.7 0.7 0.7 1"/></material>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
            <geometry>
                <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
            </geometry>
        </collision>
    </link>
    
    <joint name="back_left_joint" type="continuous">
        <parent link="base_link"/>
        <child link="back_left_wheel"/>
        <origin xyz="-0.08 0.0845 -0.0075" rpy="0 0 -0.7854"/>
        <axis xyz="0 1 0"/>
        <limit effort="100" velocity="10"/>
    </joint>

    <!-- ==================== GAZEBO PLUGINS ==================== -->
    
    <!-- 基础物理属性 -->
    <gazebo reference="base_link">
        <material>Gazebo/Green</material>
        <mu1>0.2</mu1>
        <mu2>0.2</mu2>
        <kp>1000000.0</kp>
        <kd>1.0</kd>
    </gazebo>

    <gazebo reference="laser_mount">
        <material>Gazebo/DarkGrey</material>
    </gazebo>

<!-- 激光雷达插件 - 使用已验证的配置 -->
<gazebo reference="laser_link">
    <sensor name="laserscan" type="ray">
        <plugin name="laserscan" filename="libgazebo_ros_ray_sensor.so">
            <ros>
                <namespace>/</namespace>
                <!-- 关键：将插件输出重映射到 /scan 话题 -->
                <remapping>~/out:=scan</remapping>
            </ros>
            <!-- 关键：明确指定输出为激光扫描格式 -->
            <output_type>sensor_msgs/LaserScan</output_type>
            <frame_name>laser_link</frame_name>
        </plugin>
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>40</update_rate> <!-- 你可以根据需要调整频率，比如40Hz -->
        <pose>0 0 0 0 0 0</pose>
        <!-- 激光传感器配置 -->
        <ray>
            <!-- 设置扫描范围 -->
            <scan>
                <horizontal>
                    <samples>360</samples>
                    <resolution>1.0</resolution>
                    <min_angle>-3.14159</min_angle> <!-- -π 到 π，完整一圈 -->
                    <max_angle>3.14159</max_angle>
                </horizontal>
            </scan>
            <!-- 设置扫描距离 -->
            <range>
                <min>0.12</min>
                <max>3.5</max>
                <resolution>0.01</resolution>
            </range>
        </ray>
    </sensor>
</gazebo>

    <!-- 轮子物理属性 -->
    <gazebo reference="front_right_wheel">
        <material>Gazebo/Grey</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>1.0</kd>
    </gazebo>

    <gazebo reference="front_left_wheel">
        <material>Gazebo/Grey</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>1.0</kd>
    </gazebo>

    <gazebo reference="back_right_wheel">
        <material>Gazebo/Grey</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>1.0</kd>
    </gazebo>

    <gazebo reference="back_left_wheel">
        <material>Gazebo/Grey</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>1.0</kd>
    </gazebo>

 <gazebo reference="imu_link">
    <sensor name="imu_sensor" type="imu">
        <always_on>true</always_on>
        <update_rate>100</update_rate>
        <plugin name="imu_plugin" filename="libgazebo_ros_imu_sensor.so">
            <ros>
                <namespace>/</namespace>
                <!-- 将IMU输出重映射到 /imu/data -->
                <remapping>~/out:=imu/data</remapping>
            </ros>
            <initial_orientation_as_reference>false</initial_orientation_as_reference>
        </plugin>
        <!-- 保留你之前的噪声配置 -->
        <imu>
            <angular_velocity>
                <x><noise type="gaussian"><mean>0.0</mean><stddev>0.0002</stddev></noise></x>
                <y><noise type="gaussian"><mean>0.0</mean><stddev>0.0002</stddev></noise></y>
                <z><noise type="gaussian"><mean>0.0</mean><stddev>0.0002</stddev></noise></z>
            </angular_velocity>
            <linear_acceleration>
                <x><noise type="gaussian"><mean>0.0</mean><stddev>0.017</stddev></noise></x>
                <y><noise type="gaussian"><mean>0.0</mean><stddev>0.017</stddev></noise></y>
                <z><noise type="gaussian"><mean>0.0</mean><stddev>0.017</stddev></noise></z>
            </linear_acceleration>
        </imu>
    </sensor>
</gazebo>
    <!-- 摄像头插件 -->
    <gazebo reference="camera_link">
        <sensor type="camera" name="camera_sensor">
            <update_rate>30.0</update_rate>
            <camera name="camera">
                <horizontal_fov>1.047</horizontal_fov>
                <image>
                    <width>640</width>
                    <height>480</height>
                    <format>R8G8B8</format>
                </image>
                <clip>
                    <near>0.05</near>
                    <far>100</far>
                </clip>
            </camera>
            <plugin name="camera_controller" filename="libgazebo_ros_camera.so">
                <alwaysOn>true</alwaysOn>
                <updateRate>0.0</updateRate>
                <cameraName>camera</cameraName>
                <imageTopicName>image_raw</imageTopicName>
                <cameraInfoTopicName>camera_info</cameraInfoTopicName>
                <frameName>camera_link</frameName>
                <hackBaseline>0.07</hackBaseline>
            </plugin>
        </sensor>
    </gazebo>
  <!-- ros2_control -->
  <ros2_control name="MecanumController" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>
    <joint name="front_left_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="front_right_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="back_left_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
    <joint name="back_right_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>
  <!-- Gazebo plugin for ros2_control -->
<gazebo>
  <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
    <parameters>$(find yahboomcar_mecanum_controller)/config/mecanum_controller.yaml</parameters>
  </plugin>
</gazebo>
</robot>